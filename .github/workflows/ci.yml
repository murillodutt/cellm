name: CI
# CELLM Continuous Integration
# Website: https://cellm.ai
# Repository: https://github.com/murillodutt/cellm

on:
  push:
    branches: [main]
    paths:
      - 'cellm/**'
      - '.claude-plugin/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cellm/**'
      - '.claude-plugin/**'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check plugin manifest exists
        run: |
          if [ ! -f "cellm/.claude-plugin/plugin.json" ]; then
            echo "::error::Missing plugin.json manifest"
            exit 1
          fi
          echo "[+] Plugin manifest found"

      - name: Validate plugin.json syntax
        run: |
          if ! python3 -c "import json; json.load(open('cellm/.claude-plugin/plugin.json'))"; then
            echo "::error::Invalid JSON in plugin.json"
            exit 1
          fi
          echo "[+] plugin.json syntax valid"

      - name: Check MCP configuration exists
        run: |
          if [ ! -f "cellm/.mcp.json" ]; then
            echo "::error::Missing .mcp.json configuration"
            exit 1
          fi
          echo "[+] MCP configuration found"

      - name: Validate .mcp.json syntax
        run: |
          if ! python3 -c "import json; json.load(open('cellm/.mcp.json'))"; then
            echo "::error::Invalid JSON in .mcp.json"
            exit 1
          fi
          echo "[+] .mcp.json syntax valid"

      - name: Check hooks configuration exists
        run: |
          if [ ! -f "cellm/hooks/hooks.json" ]; then
            echo "::error::Missing hooks.json configuration"
            exit 1
          fi
          echo "[+] Hooks configuration found"

      - name: Validate hooks.json syntax
        run: |
          if ! python3 -c "import json; json.load(open('cellm/hooks/hooks.json'))"; then
            echo "::error::Invalid JSON in hooks.json"
            exit 1
          fi
          echo "[+] hooks.json syntax valid"

      - name: Check required directories exist
        run: |
          REQUIRED_DIRS="cellm/agents cellm/skills cellm/commands cellm/scripts"
          for dir in $REQUIRED_DIRS; do
            if [ ! -d "$dir" ]; then
              echo "::error::Missing required directory: $dir"
              exit 1
            fi
            echo "[+] Found: $dir"
          done

      - name: Check shell scripts exist
        run: |
          REQUIRED_SCRIPTS="cellm/scripts/spawn-worker.sh cellm/scripts/health-check.sh cellm/scripts/configure-otel.sh cellm/scripts/capture-prompt.sh cellm/scripts/capture-context.sh cellm/scripts/inject-context.sh cellm/scripts/track-tool-use.sh cellm/scripts/auto-recovery.sh cellm/scripts/log-rotate.sh cellm/scripts/check-dependencies.sh"
          for script in $REQUIRED_SCRIPTS; do
            if [ ! -f "$script" ]; then
              echo "::error::Missing shell script: $script"
              exit 1
            fi
            if [ ! -x "$script" ]; then
              echo "::error::Script not executable: $script"
              exit 1
            fi
            echo "[+] Found and executable: $script"
          done

      - name: Count plugin components
        run: |
          echo "## Plugin Structure Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | $(ls cellm/agents/*.md 2>/dev/null | wc -l | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY
          echo "| Skills | $(ls -d cellm/skills/*/ 2>/dev/null | wc -l | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY
          echo "| Commands | $(ls cellm/commands/*.md 2>/dev/null | wc -l | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY
          echo "| Scripts | $(ls cellm/scripts/*.sh 2>/dev/null | wc -l | tr -d ' ') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[+] Plugin structure validated successfully" >> $GITHUB_STEP_SUMMARY

  marketplace:
    name: Validate Marketplace Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check marketplace.json exists
        run: |
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "::error::Missing marketplace.json"
            exit 1
          fi
          echo "[+] Marketplace configuration found"

      - name: Validate marketplace.json syntax
        run: |
          if ! python3 -c "import json; json.load(open('.claude-plugin/marketplace.json'))"; then
            echo "::error::Invalid JSON in marketplace.json"
            exit 1
          fi
          echo "[+] marketplace.json syntax valid"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate, marketplace]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Plugin Structure | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Marketplace Config | ${{ needs.marketplace.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.validate.result == 'failure' ||
          needs.marketplace.result == 'failure'
        run: exit 1
