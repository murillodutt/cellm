name: PR Check
# CELLM Pull Request Validation
# Website: https://cellm.ai
# Repository: https://github.com/murillodutt/cellm

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check for conventional commit format
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|refactor|test|chore)(\([a-z-]+\))?:\ .+ ]]; then
            echo "::error::PR title must follow conventional commit format: type(scope): description"
            echo "Valid types: feat, fix, docs, refactor, test, chore"
            echo "Valid scopes: skills, agents, commands, hooks, scripts, docs"
            exit 1
          fi

          echo "[+] PR title format is valid"

      - name: Detect file types changed
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD || echo "")

          SKILLS=$(echo "$CHANGED_FILES" | grep -c "^cellm/skills/" 2>/dev/null || echo "0")
          AGENTS=$(echo "$CHANGED_FILES" | grep -c "^cellm/agents/" 2>/dev/null || echo "0")
          COMMANDS=$(echo "$CHANGED_FILES" | grep -c "^cellm/commands/" 2>/dev/null || echo "0")
          HOOKS=$(echo "$CHANGED_FILES" | grep -c "^cellm/hooks/" 2>/dev/null || echo "0")
          SCRIPTS=$(echo "$CHANGED_FILES" | grep -c "^cellm/scripts/" 2>/dev/null || echo "0")
          DOCS=$(echo "$CHANGED_FILES" | grep -c "^\.github/" 2>/dev/null || echo "0")

          {
            echo "skills=${SKILLS}"
            echo "agents=${AGENTS}"
            echo "commands=${COMMANDS}"
            echo "hooks=${HOOKS}"
            echo "scripts=${SCRIPTS}"
            echo "docs=${DOCS}"
          } >> "$GITHUB_OUTPUT"

      - name: Generate PR summary
        run: |
          echo "## PR Change Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Files Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Skills | ${{ steps.changes.outputs.skills }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | ${{ steps.changes.outputs.agents }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commands | ${{ steps.changes.outputs.commands }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hooks | ${{ steps.changes.outputs.hooks }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scripts | ${{ steps.changes.outputs.scripts }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ steps.changes.outputs.docs }} |" >> $GITHUB_STEP_SUMMARY

  structure-check:
    name: Check Plugin Structure
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate plugin.json
        run: |
          if [ ! -f "cellm/.claude-plugin/plugin.json" ]; then
            echo "::error::Missing plugin.json manifest"
            exit 1
          fi
          if ! python3 -c "import json; json.load(open('cellm/.claude-plugin/plugin.json'))"; then
            echo "::error::Invalid JSON in plugin.json"
            exit 1
          fi
          echo "[+] plugin.json valid"

      - name: Validate .mcp.json.example
        run: |
          if [ ! -f "cellm/.mcp.json.example" ]; then
            echo "::error::Missing .mcp.json.example template"
            exit 1
          fi
          if ! python3 -c "import json; json.load(open('cellm/.mcp.json.example'))"; then
            echo "::error::Invalid JSON in .mcp.json.example"
            exit 1
          fi
          echo "[+] .mcp.json.example valid"

      - name: Validate hooks.json
        run: |
          if [ ! -f "cellm/hooks/hooks.json" ]; then
            echo "::error::Missing hooks.json"
            exit 1
          fi
          if ! python3 -c "import json; json.load(open('cellm/hooks/hooks.json'))"; then
            echo "::error::Invalid JSON in hooks.json"
            exit 1
          fi
          echo "[+] hooks.json valid"

  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add labels based on changes
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Get changed files
            const changedFiles = execSync(
              `git diff --name-only origin/${{ github.base_ref }}...HEAD`
            ).toString().split('\n').filter(f => f);

            const labels = new Set();

            // Determine labels based on file paths
            for (const file of changedFiles) {
              if (file.startsWith('cellm/skills/')) labels.add('skills');
              if (file.startsWith('cellm/agents/')) labels.add('agents');
              if (file.startsWith('cellm/commands/')) labels.add('commands');
              if (file.startsWith('cellm/hooks/')) labels.add('hooks');
              if (file.startsWith('cellm/scripts/')) labels.add('scripts');
              if (file.startsWith('.github/')) labels.add('documentation');
            }

            // Add labels if any found
            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: Array.from(labels)
                });
                console.log(`Added labels: ${Array.from(labels).join(', ')}`);
              } catch (error) {
                console.log(`Could not add labels: ${error.message}`);
              }
            }
